define(function(require){require("jquery.form")($);return function($){$.fn.candyAjaxSubmit=function(options){options=options||{};var $form=this;var defaults={url:$form.attr("url")||window.location.href||"",type:$form.attr("url")||"POST",dataType:"json",data:null,loading:true,target:null,submitButton:null,sendingLabel:"发送中",successLabel:"发送成功",errorLabel:"发送失败",beforeSubmit:function(){},success:function(data){return data},error:function(error){}};var opts=$.extend({},defaults,options);var $button;if(typeof opts.submitButton=="Object"){$button=opts.submitButton}else if(typeof opts.submitButton=="string"){$button=$("#"+opts.submitButton)}else{$button=$form.find("*[type=submit]")}var statusTip=$("#statusTip");if(!statusTip.length){$form.after('<div id="statusTip" class="display:none"><img src="/static/images/loading.gif"></div>');statusTip=$("#statusTip")}var sysAlert={beforeSubmit:function(){opts.beforeSubmit();statusTip.removeClass("alert alert-success alert-error").html('<img src="/static/images/loading.gif">').show();changeLabel($button,opts.sendingLabel,true)},success:function(data){if(opts.dataType=="json"&&data.error){setTimeout(function(){statusTip.hide().html(data.error).addClass("alert alert-error").fadeIn(500);changeLabel($button,opts.errorLabel,false);opts.error(data)},500);setTimeout(function(){statusTip.fadeOut(300)},4e3)}else{setTimeout(function(){statusTip.hide().html("内容发布成功!").addClass("alert alert-success").fadeIn(500);changeLabel($button,opts.successLabel,false);opts.success(data);$form.resetForm()},500);setTimeout(function(){statusTip.fadeOut(300)},2e3)}},error:function(data){changeLabel($button,opts.errorLabel,false);statusTip.hide().html("很抱歉,系统超时或出错，请与管理员联系!").addClass("alert alert-error").fadeIn(500);opts.error(data)}};var changeLabel=function($button,label,disabled){if($button[0].tagName=="INPUT"){$button.attr("value",label)}else{$button.html(label)}return $button.attr("disabled",disabled)};$form.ajaxSubmit($.extend({},opts,sysAlert))};$.fn.candyForm=function(options){if(this.length){var $form=this;$form.bind("submit",function(e){e.preventDefault();$form.candyAjaxSubmit(options)})}}}(jQuery)});